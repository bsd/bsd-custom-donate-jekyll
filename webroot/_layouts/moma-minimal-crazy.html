<!DOCTYPE html>
<!--[if lt IE 7 ]><html lang="en" class="no-js oldie ie6"><![endif]-->
<!--[if IE 7 ]><html lang="en" class="no-js oldie ie7"><![endif]-->
<!--[if IE 8 ]><html lang="en" class="no-js oldie ie8"><![endif]-->
<!--[if IE 9 ]><html lang="en" class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="google-translate-customization" content="4207688dd80f0303-9df5bffa9878b12e-g350add1bfba29207-17">

    <title>MOMA</title>

<!--[if lte IE 8]><link rel="stylesheet" href="/page/-/donate/moma-minimal/bsdcd-styles-desktop.css"><![endif]-->
<!--[if gt IE 8]><!--><link rel="stylesheet" href="/page/-/donate/moma-minimal/bsdcd-styles.css"><!--<![endif]-->
<script src="/page/-/donate/moma-minimal/modernizr.js"></script>
</head>

    <body class="full-width background-white">

        {% include default-form.html %}

<script>

(function($,w, M){
    var on = false,
        together = false,
        pull = false,
        canvas,
        $canvas,
        $canvas2,
        $w = $(w),
        ww = $w.width(),
        wh = $w.height(),
        $body = $('body'),
        context,
        stars = [],
        number = 300,
        speed = 5,
        started = false,
        g;

    

//start crazy

function iestars(){
    g = 20;
    $canvas = $('<div/>',{'class':'oldstars'});
    $canvas2 = $canvas.clone().addClass('oldstars2').css('background-position','200px 20px').hide()
    $body.prepend($canvas).prepend( $canvas2 );

    function fo($this,sp,bp){
        $this.fadeOut(sp,function(){
            $this.css('background-position',bp+'px '+((++g)*50)+'px');
            fi($this,sp,bp);
        });
    }
    function fi($this,sp,bp){
        $this.fadeIn(sp,function(){
            fo($this,sp,bp);
        });
    }
    fo($canvas,11500,'20');
    setTimeout(function(){
        fi($canvas2,12000,'200');
    },500);
}



function canvasstars(){

    $body.prepend('<canvas id="stars"/>');

        canvas = document.getElementById('stars');
        $canvas = $(canvas).attr({'width':ww,'height':wh});
        context = canvas.getContext('2d');

var particles = [],
    PULSATION = true,
    PULSATION_PERIOD = 200,
    PARTICLE_RADIUS = 16,
    partnum = 2600;
    total_area = ww * wh;
  single_particle_area = total_area / partnum;
  area_length = M.sqrt(single_particle_area);



  function particle(i) {
    this.r = 255; //M.round(M.random() * 255 | 0);
    this.g = 255; //M.round(M.random() * 255 | 0);
    this.b = 255;// M.round(M.random() * 255 | 0);
    this.alpha = 1;

    this.x = (i * area_length) % ww;
    this.y = (i * area_length) / ww * area_length;


    //randomize delta to make particles sparkling 
    this.deltaOffset = M.random() * PULSATION_PERIOD | 4;

    this.radius = 0.1 + M.random() * 0.1;
  }
for(var i = 1; i <= partnum; i++) {
    particles.push(new particle(i));
  }
  console.log(particles.length);

var QUALITY = 3,
    FANCY_FONT = "Helvetica",
    QUALITY_TO_FONT_SIZE = [10, 20, 50, 100, 200, 350],
    QUALITY_TO_SCALE = [20, 14, 6, 3, 1.5, 0.9],
    QUALITY_TO_TEXT_POS = [10, 18, 43, 86, 170, 280],
    BLENDING = true,
    TREMBLING = 1,
    BLINK = false,
    BLUR = false,
    BACKGROUND = "#002a55",
    GLOBAL_PULSATION = true,
    tcanvas = document.createElement("canvas"),
    tctx = tcanvas.getContext("2d"),
    times = 0,
    otherpos = [],
    text,
    image_data,
    pixels, positions = [];

    tcanvas.width = ww;
    tcanvas.height = wh;
    tctx.fillStyle = "white";
    tctx.fillRect(0, 0, ww, wh)
    tctx.fill();

    tctx.font = "bold " + QUALITY_TO_FONT_SIZE[QUALITY] + "px " + FANCY_FONT;
    text = "Thank You" || String(M.random()).substr(-3);

    tctx.strokeStyle = "black";
    tctx.strokeText(text, (QUALITY + 1) * 5, QUALITY_TO_TEXT_POS[QUALITY]);

    image_data = tctx.getImageData(0, 0, ww, wh);
    pixels = image_data.data;


    for(var i = 0; i < pixels.length; i = i + 4) {
      if(pixels[i] != 255) {
        position = {
          x: ((i / 8 % ww | 0) * QUALITY_TO_SCALE[QUALITY] | 0)+ (ww/2) - 400,
          y: ((i / 14 / wh | 0) * QUALITY_TO_SCALE[QUALITY] | 0) + (wh/2) - 100
        }
        positions.push(position);
      }
    }
    console.log(positions.length);

otherpos = positions.slice(0);

console.log(positions.length, otherpos.length);

function get_destinations() {
    console.log('orig',positions.length);
    var pa, nearest_position, po;
    for(var i = 0; i < particles.length; i++) {
      pa = particles[i];
      particles[i].alpha = 1;
      var distance = [];
      nearest_position = 0;
      if(positions.length) {
        for(var n = 0; n < positions.length; n++) {
          po = positions[n];
          distance[n] = M.sqrt((pa.x - po.x) * (pa.x - po.x) + (pa.y - po.y) * (pa.y - po.y));
          if(n > 0) {
            if(distance[n] <= distance[nearest_position]) {
              nearest_position = n;
            }
          }
        }
        particles[i].dx = positions[nearest_position].x;
        particles[i].dy = positions[nearest_position].y;
        particles[i].distance = distance[nearest_position];

        particles[i].x = particles[i].dx;
        particles[i].y = particles[i].dy;

        var po1 = positions[nearest_position];
        for(var n = 0; n < positions.length; n++) {
          var po2 = positions[n];
          distance = M.sqrt((po1.x - po2.x) * (po1.x - po2.x) + (po1.y - po2.y) * (po1.y - po2.y));
          if(distance <= 5) {
            positions.splice(n, 1);
          }
        }
      }
    }
  }


get_destinations();

  function drawWord() {

    var now = Date.now();

    context.globalCompositeOperation = "source-over";
        
    if(BLUR) { context.globalAlpha = 0.1; }
        else if(!BLUR && !BLINK) { context.globalAlpha = 1.0; }
        
    //context.fillStyle = BACKGROUND;
    //context.fillRect(0, 0, ww, wh)

    if(BLENDING) { context.globalCompositeOperation = "lighter"; }

    for(var i = 0; i < particles.length; i++) {
      p = particles[i];

      //in lower qualities there is not enough full pixels for all of  them - dirty hack

      if(isNaN(p.x)) { continue }

        


      if(!PULSATION) { // this would be 0 -> 1 
                var mod = ((GLOBAL_PULSATION ? 0 : p.deltaOffset) + now) % PULSATION_PERIOD / PULSATION_PERIOD;

        // lets make the value bouncing with sinus 
        mod = M.sin(mod * M.PI);
      } else { var mod = 1; }

      context.beginPath();
      //context.fillStyle = "rgb(" + p.r + ", " + p.g + ", " + p.b + ")";
      context.fillStyle = "rgba(" + p.r + ", " + p.g + ", " + p.b + ", " + p.alpha + ")";


      p.alpha = (together)?0.3:((pull)?0.1:0);

      var offset = TREMBLING ? TREMBLING * (-1 + M.random() * 2) : 0;
            
      var radius = PARTICLE_RADIUS * p.radius;

      
    context.arc(offset + p.x | 0, offset + p.y | 0, radius * mod, M.PI * 2, false);
    context.fill();


        if (!together){
            p.x += 526 * M.random() * (M.random() < .5 ? -1 : 1);
            p.y += 526 * M.random() * (M.random() < .5 ? -1 : 1);
        }else {
            p.x += ((p.dx - p.x) / 4) + (M.random()*2 * (M.random() < .5 ? -1 : 1));
            p.y += ((p.dy - p.y) / 2) + (M.random()*2 * (M.random() < .5 ? -1 : 1));
        }
    }
    times++;
  }

  //drawWord();


///end crazy



function starpredestination() {

    console.log('what',stars.length, otherpos.length);
    var pa,nearest_position,po;
    for(var i = 0; i < stars.length; i++) {
      pa = stars[i];
      stars[i].alpha = 1;
      var distance = [];
      nearest_position = 0;
      if(otherpos.length) {
        for(var n = 0; n < otherpos.length; n++) {
          po = otherpos[n];
          distance[n] = M.sqrt((pa.x - po.x) * (pa.x - po.x) + (pa.y - po.y) * (pa.y - po.y));
          if(n > 0) {
            if(distance[n] <= distance[nearest_position]) {
              nearest_position = n;
            }
          }
        }

        stars[i].wdx = otherpos[nearest_position].x;
        stars[i].wdy = otherpos[nearest_position].y;
        stars[i].distance = distance[nearest_position];

        //stars[i].x = stars[i].wdx;
        //stars[i].y = stars[i].wdy;

        var po1 = otherpos[nearest_position];
        for(var n = 0; n < otherpos.length; n++) {
          var po2 = otherpos[n];
          distance = M.sqrt((po1.x - po2.x) * (po1.x - po2.x) + (po1.y - po2.y) * (po1.y - po2.y));
          if(distance <= 5) {
            otherpos.splice(n, 1);
          }
        }
      }
    }

  }

    function create(){
        stars = [];
        for(var i = 0; i < number; i++) {
            stars[i] = new Circle(ww,wh);
            stars[i].reset();
        }
        starpredestination();
        if (!started) { draw(); started = true; }
    }
  
    function draw() {
        var ln = stars.length-1;

        context.clearRect(0,0,ww,wh);      
        
        while(on && ln--) {
            stars[ln].move();
            stars[ln].draw();
        }

        drawWord();
        requestAnimationFrame(draw);
    }

    function Circle(www,wwh) {
        this.s = {ttl:2000, xmax:5, ymax:2, rmax:6, rt:1};

        this.reset = function() {
            this.x = www*M.random();
            this.y = wwh*M.random();
            this.r = ((this.s.rmax-1)*M.random()) + 1;
            this.dx = (M.random()*this.s.xmax) * (M.random() < .5 ? -1 : 1);
            this.dy = (M.random()*this.s.ymax) * (M.random() < .5 ? -1 : 1);
            this.hl = (this.s.ttl/speed)*(this.r/this.s.rmax);
            this.rt = M.random()*this.hl;
            this.s.rt = M.random()+1;
            this.stop = M.random()*.5+.3;
        }

        this.move = function() {

            if(!together && !pull){
                this.x += ((this.rt/this.hl)*this.dx) / 120;
                this.y += (this.rt/this.hl)*0.1;
                if(this.x > www || this.x < 0) { this.dx *= -1; }
                if(this.y < 0) { this.dy *= -1; }
                if(this.y > wwh){  this.y = 0; }
            }
            else if (pull){
                this.x += ((this.rt/this.hl)*this.dx) / 10;
                this.y += (this.rt/this.hl)*2;
                if(this.x > www || this.x < 0) { this.dx *= -1; }
                if(this.y < 0) { this.dy *= -1; }
                if(this.y > wwh){  this.y = 0; }    
            }
            else {
                this.x += ((this.wdx - this.x) / 30) + (M.random()*2 * (M.random() < .5 ? -1 : 1));
                this.y += ((this.wdy - this.y) / 30) + (M.random()*2 * (M.random() < .5 ? -1 : 1));
            }
        }

        this.draw = function() {
            this.rt += this.s.rt;

            if(this.rt <= 0.1 || this.rt >= this.hl){ this.s.rt = this.s.rt*-1; this.rt += this.s.rt; }
            var newo = M.abs(M.round(1-(this.rt/this.hl)*1000)/1000), cr;
                //newo = (newo>1)?1:((newo<0)?0:newo);
                cr = this.r*newo;
                context.beginPath();
                context.arc(this.x,this.y,this.r,0,M.PI*2,true);
                context.closePath();
                g = context.createRadialGradient(this.x, this.y, 0, this.x, this.y, cr);
                g.addColorStop(0.0, 'rgba(255,255,255,'+newo+')');
                g.addColorStop(this.stop, 'rgba(86,101,181,'+(newo*0.6)+')');
                g.addColorStop(1.0, 'rgba(86,101,181,0)');
                context.fillStyle = g;
                context.fill();

        }


    }

    $w.on('resize',function(){
        wh = $w.height();
        ww = $w.width();
        on = (ww>785);
        if(on){ create(); }
    }).trigger('resize');

}
if (!Modernizr.canvas){
    $('html').addClass('oldie');
    iestars();
}else{
    canvasstars();
}
    function succeed(resobj){
        $('.bsdcd-outer-container').fadeTo(100,0);
        together = true;
        pull = true;
        console.log(resobj);
        setTimeout(function(){
            together = false;
            setTimeout(function(){
                window.location.href = resobj.redirect_url;
            },200);
        },2000);
    }

    window.succeed = succeed;


}(jQuery,window, Math));
</script>
    </body>
</html>